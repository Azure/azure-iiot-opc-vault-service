#!/usr/bin/env bash

set -e
APP_HOME="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )/"
source "$APP_HOME/scripts/.functions.sh"

setup_cache() {
    cd $APP_HOME
    mkdir -p .cache/sandbox/.config
    mkdir -p .cache/sandbox/.dotnet
    mkdir -p .cache/sandbox/.nuget
}

run_in_sandbox() {
    cd $APP_HOME

    # On Windows this script should use docker.exe, in which case
    # the parameters syntax is different, e.g. volumes path
    # (i.e. C:\path\path\... vs /c/path/path/...). Note that this
    # script is also used for the git precommit hook.
    set +e
    IS_WINDOWS=$(which cmd.exe)
    set -e
    if [[ -z "$IS_WINDOWS" ]]; then
        check_dependency_docker

        ./scripts/env-vars-check

        # Note: the ports used must be exposed by `code-builder-dotnet`
        #       see https://hub.docker.com/r/azureiotpcs/code-builder-dotnet
        # Some settings are used to connect to an external dependency, e.g. Azure IoT Hub and IoT Hub Manager API
        # Depending on which settings and which dependencies are needed, edit the list of variables
        docker run -it \
            -p $PCS_PROJECTNAMEHERE_WEBSERVICE_PORT:8080 \
            -e "PCS_PROJECTNAMEHERE_WEBSERVICE_PORT=8080" \
            -e "PCS_IOTHUB_CONN_STRING=$PCS_IOTHUB_CONN_STRING" \
            -e "PCS_IOTHUBMANAGER_WEBSERVICE_URL=$PCS_IOTHUBMANAGER_WEBSERVICE_URL" \
            -v "$APP_HOME/.cache/sandbox/.config:/root/.config" \
            -v "$APP_HOME/.cache/sandbox/.dotnet:/root/.dotnet" \
            -v "$APP_HOME/.cache/sandbox/.nuget:/root/.nuget" \
            -v "$APP_HOME:/opt/code" \
            azureiotpcs/code-builder-dotnet:1.0-dotnetcore /opt/scripts/run
    else
        # Note 'winpty' is required to provide a TTY to Docker
        cmd.exe /c "winpty .\scripts\run-in-sandbox.cmd"
    fi
}

setup_cache
run_in_sandbox

set +e
